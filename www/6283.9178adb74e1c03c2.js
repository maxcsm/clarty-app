"use strict";(self.webpackChunkapp=self.webpackChunkapp||[]).push([[6283],{6283:($,_,l)=>{l.r(_),l.d(_,{ChatDocPageModule:()=>B});var p=l(177),f=l(9417),a=l(8974),h=l(904),c=l(467),t=l(4438),v=l(995),b=l(6432),I=l(9109),C=l(1626),x=l(3013);const y=["scrollArea"];function P(i,u){if(1&i&&(t.j41(0,"div",24),t.nrm(1,"div",25),t.k0s()),2&i){const e=t.XpG().$implicit;t.R7$(),t.Y8G("innerHtml",e.text,t.npT)}}function R(i,u){if(1&i&&(t.j41(0,"div",26),t.nrm(1,"div",25),t.k0s()),2&i){const e=t.XpG().$implicit;t.R7$(),t.Y8G("innerHtml",e.text,t.npT)}}function T(i,u){if(1&i&&(t.j41(0,"div",21),t.DNE(1,P,2,1,"div",22)(2,R,2,1,"div",23),t.k0s()),2&i){const e=u.$implicit;t.Y8G("ngClass",e.sender),t.R7$(),t.Y8G("ngIf","assistant"==e.sender),t.R7$(),t.Y8G("ngIf","user"==e.sender)}}function k(i,u){1&i&&t.nrm(0,"ion-spinner",27)}function j(i,u){if(1&i){const e=t.RV6();t.qex(0),t.j41(1,"ion-button",31),t.bIt("click",function(){const s=t.eBV(e).$implicit,r=t.XpG().$implicit,o=t.XpG(2);return t.Njj(o.applySuggestion(r,s))}),t.EFF(2),t.k0s(),t.bVm()}if(2&i){const e=u.$implicit;t.R7$(2),t.SpI(" ",e," ")}}function S(i,u){if(1&i&&(t.j41(0,"div",29),t.DNE(1,j,3,1,"ng-container",30),t.k0s()),2&i){const e=u.$implicit;t.R7$(),t.Y8G("ngForOf",e.suggestions)}}function D(i,u){if(1&i&&(t.j41(0,"div"),t.DNE(1,S,2,1,"div",28),t.k0s()),2&i){const e=t.XpG();t.R7$(),t.Y8G("ngForOf",e.corrections)}}function A(i,u){1&i&&(t.j41(0,"div",32),t.nrm(1,"ion-spinner",33),t.k0s())}function G(i,u){if(1&i){const e=t.RV6();t.j41(0,"ion-button",34),t.bIt("click",function(){t.eBV(e);const s=t.XpG();return t.Njj(s.startListening())}),t.nrm(1,"ion-icon",35),t.k0s()}}function M(i,u){if(1&i){const e=t.RV6();t.j41(0,"ion-button",34),t.bIt("click",function(){t.eBV(e);const s=t.XpG();return t.Njj(s.stopListening())}),t.nrm(1,"ion-icon",36),t.k0s()}}const O=[{path:"",component:(()=>{class i{constructor(e,n,s,r,o,g,d,m){this.redditService=e,this.loadingController=n,this.openaiService=s,this.localStore=r,this.route=o,this.router=g,this.http=d,this.speechRecognition=m,this.userInput="",this.response="",this.thread_id="",this.aiResponse="",this.messages=["Quel est le type d assurance ?"],this.spinner=!1,this.fullText="",this.corrections=[],this.text="",this.isListening=!1,this.matches=[]}ionViewWillEnter(){this.iduser=this.localStore.getItem("iduser"),this.vectorStoreId=this.localStore.getItem("vectorStoreId"),this.userInput=""}ngOnInit(){var e=this;return(0,c.A)(function*(){const n=yield e.loadingController.create({message:"Chargement en cours"});n.present(),e.route.params.subscribe(s=>{e.id=s.id,e.getdata(n)})})()}getdata(e){var n=this;return(0,c.A)(function*(){n.redditService.getByid("assistants",n.id).subscribe(s=>{console.log(s),n.posts=[s],n.title=n.posts[0].title,n.vector_id=n.posts[0].id_vector,n.assitant_id=n.posts[0].assitant_id,n.thread_id=n.posts[0].thread_id,n.category=n.posts[0].category,n.getHistorique(e)})})()}getHistorique(e){var n=this;return(0,c.A)(function*(){n.redditService.getMessagesBythread(n.thread_id).subscribe(s=>{e.dismiss(),n.historiques=s.messages.data.reverse(),console.log("----LOG CATEGORY-------"),console.log(n.historiques.length),console.log(n.category),n.historiques.length<1&&"devis"==n.category?(n.userInput="R\xe9pondre \xe0 mes questions consernant le devis ?",n.askAI()):n.historiques.forEach(function(){var r=(0,c.A)(function*(o){n.aiResponse=o.content[0].text.value.replace(/\*\*/g,""),n.messages.push({text:n.aiResponse,sender:o.role}),n.scrollToBottom()});return function(o){return r.apply(this,arguments)}}())})})()}scrollToTop(){this.content.scrollToBottom(500)}getSpinner(){var e=this;return(0,c.A)(function*(){e.spinner=!0})()}stopSpinner(){var e=this;return(0,c.A)(function*(){e.spinner=!1})()}runAI(){var e=this;return(0,c.A)(function*(){e.getSpinner(),e.aiResponse="",e.messages.push({text:e.userInput,sender:"user"}),yield e.openaiService.streamThreadSaveQuestion(e.thread_id,e.assitant_id,e.vector_id,e.userInput,n=>{n=n.replace(/\*\*/g,""),console.log(n),e.aiResponse+=n,console.log(e.aiResponse),console.log("-----***source******----"),e.aiResponse.includes("\n")&&(console.log("Il y a un retour \xe0 la ligne !"),e.messages.push({text:e.aiResponse,sender:"assistant"}),e.scrollToBottom(),e.aiResponse="",e.stopSpinner(),e.userInput="")})})()}runAssitant(){var e=this;return(0,c.A)(function*(){e.getSpinner(),e.aiResponse="",e.messages.push({text:e.userInput,sender:"user"}),yield e.openaiService.streamThreadSaveQuestion(e.thread_id,e.assitant_id,e.vector_id,e.userInput,n=>{n=n.replace(/\*\*/g,""),console.log(n),e.aiResponse+=n,console.log(e.aiResponse),console.log("-----***source******----"),e.aiResponse.includes("\n")&&(console.log("Il y a un retour \xe0 la ligne !"),e.messages.push({text:e.aiResponse,sender:"assistant"}),e.scrollToBottom(),e.aiResponse="",e.stopSpinner(),e.userInput="")})})()}askAI(){var e=this;return(0,c.A)(function*(){console.log("-------- Send message -----------");const n=yield e.loadingController.create({});n.present();var s=JSON.stringify({content:e.userInput,thread_id:e.thread_id});console.log(s),e.update(e.userInput),e.redditService.addPost("addMessageToThread",s).subscribe(function(){var r=(0,c.A)(function*(o){console.log(o),setTimeout(()=>{e.runAI(),e.userInput="",e.isListening&&e.stopListening(),n.dismiss()},200)});return function(o){return r.apply(this,arguments)}}())})()}update(e){var n=this;return(0,c.A)(function*(){var s={title:e};console.log(s),n.redditService.update("assistants",n.id,s).toPromise().then(function(){var r=(0,c.A)(function*(o){console.log(o)});return function(o){return r.apply(this,arguments)}}())})()}checkForSource(e){return/\u2020source\u3011./.test(e)}searchForAnySource(e){return/\[\d+:\d+\u2020source\]/.test(e)}scrollToBottom(){setTimeout(()=>{this.content.scrollToBottom(300)},100)}CreateAssistantThreadByFile(){var e=this;return(0,c.A)(function*(){var n=JSON.stringify({vector_store_id:e.vectorStoreId,title:e.title,userid:e.iduser,category:"Tous les fichiers"});console.log(n);const s=yield e.loadingController.create({message:"Chargement en cours"});s.present(),e.redditService.addPost("CreateAssistantThreadByFile",n).subscribe(function(){var r=(0,c.A)(function*(o){console.log(o),setTimeout(()=>{console.log(o.assistant.id),s.dismiss(),e.router.navigateByUrl("/chat-doc/"+o.assistant.id)},1e3)});return function(o){return r.apply(this,arguments)}}())})()}correctWord(e,n){var s=this,r=JSON.stringify({text:this.userInput});this.redditService.addPost("languagetool",r).subscribe(function(){var o=(0,c.A)(function*(g){console.log(g),s.corrections=g.matches.map(d=>({word:d.context.text.substr(d.context.offset,d.length),offset:d.offset,length:d.length,suggestions:d.replacements.slice(0,6).map(m=>m.value),message:d.message}))});return function(g){return o.apply(this,arguments)}}())}onInputChange(){if(console.log(" CHANGE ----"),!this.userInput.endsWith(" "))return;const e=this.userInput.trim().split(/\s+/),n=e[e.length-1];n.length<2||this.correctWord(n,e.length-1)}applySuggestion(e,n){const s=this.userInput.slice(0,e.offset),r=this.userInput.slice(e.offset+e.length);this.userInput=s+n+r,this.corrections=this.corrections.filter(o=>o.offset!==e.offset)}startListening(){var e=this;return(0,c.A)(function*(){if(e.isListening)console.warn("La reconnaissance est d\xe9j\xe0 en cours");else try{yield e.speechRecognition.requestPermission(),e.isListening=!0,e.speechRecognition.startListening({language:"fr-FR",showPopup:!0,showPartial:!0}).subscribe(s=>{e.matches=s,e.isListening=!0,console.log("R\xe9sultat:",s),e.userInput=s[0]},s=>{console.error("Erreur reconnaissance vocale :",s),e.isListening=!1})}catch(n){console.warn("Permission refus\xe9e",n),e.isListening=!1}})()}stopListening(){this.isListening=!1,this.speechRecognition.stopListening()}static{this.\u0275fac=function(n){return new(n||i)(t.rXU(v.s),t.rXU(a.Xi),t.rXU(b.Y),t.rXU(I.n),t.rXU(h.nX),t.rXU(h.Ix),t.rXU(C.Qq),t.rXU(x.o))}}static{this.\u0275cmp=t.VBU({type:i,selectors:[["app-chat-doc"]],viewQuery:function(n,s){if(1&n&&t.GBs(y,5),2&n){let r;t.mGM(r=t.lsd())&&(s.content=r.first)}},decls:28,vars:9,consts:[["scrollArea",""],["lines","none"],["slot","start"],["color","primary"],["slot","end",1,"fade-in","delay-1",3,"click"],["color","primary","name","add-circle-outline",2,"font-size","30px","right","0px"],["id","chat-content",2,"background-color","white","height","100%",3,"scrollEvents","fullscreen"],[2,"background-color","white !important","height","100%"],["sizeLg","12","sizeMd","12","sizeXs","12",2,"background-color","white !important","padding-bottom","200px"],[2,"background-color","white !important"],[3,"ngClass",4,"ngFor","ngForOf"],["name","bubbles",4,"ngIf"],["lines","none",2,"display","none"],[4,"ngIf"],[1,"chat-footer"],["lines","none",1,"input-bubble"],["placeholder","Votre message...","autocorrect","on","spellcheck","true","rows","4","auto-grow","true",1,"instagram-input",3,"ngModelChange","ionInput","keyup.enter","ngModel"],["color","light","slot","end","fill","clear",1,"send-btn",3,"click"],["name","send","color","primary"],["class","loader-container",4,"ngIf"],["slot","end","color","light",3,"click",4,"ngIf"],[3,"ngClass"],["class","message-bubble ai",4,"ngIf"],["class","message-bubble user",4,"ngIf"],[1,"message-bubble","ai"],[3,"innerHtml"],[1,"message-bubble","user"],["name","bubbles"],["style","margin-top: 10px;",4,"ngFor","ngForOf"],[2,"margin-top","10px"],[4,"ngFor","ngForOf"],["size","small","fill","outline","color","light",3,"click"],[1,"loader-container"],["name","dots"],["slot","end","color","light",3,"click"],["name","mic-circle-outline"],["name","stop-circle-outline"]],template:function(n,s){if(1&n){const r=t.RV6();t.j41(0,"ion-header")(1,"ion-toolbar",1)(2,"ion-buttons",2),t.nrm(3,"ion-menu-button",3),t.k0s(),t.j41(4,"ion-buttons",4),t.bIt("click",function(){return t.eBV(r),t.Njj(s.CreateAssistantThreadByFile())}),t.j41(5,"h4"),t.EFF(6," Cr\xe9er un nouvelle discussion "),t.k0s(),t.nrm(7,"ion-icon",5),t.k0s()()(),t.j41(8,"ion-content",6,0)(10,"ion-row",7)(11,"ion-col",8)(12,"div",9),t.DNE(13,T,3,3,"div",10)(14,k,1,0,"ion-spinner",11),t.k0s()()()(),t.j41(15,"ion-item",12),t.DNE(16,D,2,1,"div",13),t.k0s(),t.j41(17,"ion-footer",14)(18,"ion-toolbar")(19,"ion-item",15)(20,"ion-input",16),t.mxI("ngModelChange",function(g){return t.eBV(r),t.DH7(s.userInput,g)||(s.userInput=g),t.Njj(g)}),t.bIt("ionInput",function(){return t.eBV(r),t.Njj(s.onInputChange())})("keyup.enter",function(){return t.eBV(r),t.Njj(s.askAI())}),t.k0s(),t.j41(21,"ion-button",17),t.bIt("click",function(){return t.eBV(r),t.Njj(s.askAI())}),t.nrm(22,"ion-icon",18),t.k0s()()(),t.j41(23,"ion-toolbar")(24,"ion-item",15),t.DNE(25,A,2,0,"div",19)(26,G,2,0,"ion-button",20)(27,M,2,0,"ion-button",20),t.k0s()()()}2&n&&(t.R7$(8),t.Y8G("scrollEvents",!0)("fullscreen",!0),t.R7$(5),t.Y8G("ngForOf",s.messages),t.R7$(),t.Y8G("ngIf",1==s.spinner),t.R7$(2),t.Y8G("ngIf",s.corrections.length>0),t.R7$(4),t.R50("ngModel",s.userInput),t.R7$(5),t.Y8G("ngIf",s.isListening),t.R7$(),t.Y8G("ngIf",!s.isListening),t.R7$(),t.Y8G("ngIf",s.isListening))},dependencies:[p.YU,p.Sq,p.bT,f.BC,f.vS,a.Jm,a.QW,a.hU,a.W9,a.M0,a.eU,a.iq,a.$w,a.uz,a.MC,a.ln,a.w2,a.ai,a.Gw],styles:[".roundedInput[_ngcontent-%COMP%]{--border-color: gray;--border-radius: 5px;--border-width: 2px;--box-shadow: 2px gray;--highlight-height: 0;--background: #ffffff;padding:2%;height:50px}ion-boutton[_ngcontent-%COMP%]{text-transform:capitalize}.chat-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding:10px}.user[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{background-color:#d7d7d7;align-self:flex-end;border-radius:15px;padding:10px;margin:5px 0;max-width:100%;white-space:pre-line}.assistant[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{background-color:#fff;color:#000;align-self:flex-start;border-radius:15px;padding:10px;line-height:1;margin:5px 0;max-width:100%;white-space:pre-line}.ai[_ngcontent-%COMP%]   .message-bubble[_ngcontent-%COMP%]{background-color:#fff;color:#000;align-self:flex-start;border-radius:15px;padding:10px;font-weight:700;line-height:1;margin:5px 0;max-width:70%;white-space:pre-line}ion-content[_ngcontent-%COMP%]{background-color:#fff!important}ion-footer[_ngcontent-%COMP%]{background-color:#fff!important}.rounded-footer[_ngcontent-%COMP%]{height:100px;border-top-left-radius:20px;border-top-right-radius:20px;overflow:hidden}.instagram-input[_ngcontent-%COMP%]{white-space:pre-wrap}"]})}}return i})()}];let w=(()=>{class i{static{this.\u0275fac=function(n){return new(n||i)}}static{this.\u0275mod=t.$C({type:i})}static{this.\u0275inj=t.G2t({imports:[h.iI.forChild(O),h.iI]})}}return i})(),B=(()=>{class i{static{this.\u0275fac=function(n){return new(n||i)}}static{this.\u0275mod=t.$C({type:i})}static{this.\u0275inj=t.G2t({imports:[p.MD,f.YN,a.bv,w]})}}return i})()}}]);